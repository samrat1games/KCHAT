<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KChat Messenger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <style>
        body { margin: 0; padding: 0; }
        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
            --bg-main: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-main: #000000;
            --text-secondary: #666666;
            --accent: #007AFF;
            --border-color: #e0e0e0;
            --message-bg: #f0f0f0;
            --message-own-bg: #e3f2fd;
            --header-bg: #f8f8f8;
            --hover-bg: rgba(0,0,0,0.05);
            --shadow: rgba(0,0,0,0.1);
        }

        /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
        body.theme-dark {
            --bg-main: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-main: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #0A84FF;
            --border-color: #404040;
            --message-bg: #333333;
            --message-own-bg: #1c4a6e;
            --header-bg: #2d2d2d;
            --hover-bg: rgba(255,255,255,0.1);
            --shadow: rgba(0,0,0,0.3);
        }

        /* –ì–æ–ª—É–±–∞—è —Ç–µ–º–∞ */
        body.theme-blue {
            --bg-main: #f0f7ff;
            --bg-secondary: #e1f0ff;
            --text-main: #1a1a1a;
            --text-secondary: #4a6f8c;
            --accent: #2b88ff;
            --border-color: #cce4ff;
            --message-bg: #e1f0ff;
            --message-own-bg: #d1e8ff;
            --header-bg: #e8f3ff;
            --hover-bg: rgba(43,136,255,0.1);
            --shadow: rgba(43,136,255,0.2);
        }

        /* –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º */
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
        }
        #sidebar {
            background: var(--bg-secondary);
        }
        .sidebar-header {
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar-chat-card {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
        }
        .message {
            background: var(--message-bg);
            color: var(--text-main);
        }
        .message.samrat {
            background: var(--message-own-bg);
        }
        .modal-content {
            background: var(--bg-main);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        input, select, button {
            background: var(--bg-main);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        button:hover {
            background: var(--hover-bg);
        }
        #main-layout { display: flex; flex-direction: row; height: 100vh; }
        #sidebar { min-width: 0; width: 25vw; max-width: 400px; flex: 0 0 25vw; display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 0; background: var(--sidebar-bg, #f5f5f5); height: 100vh; box-sizing: border-box; }
        .sidebar-header { 
            width: 100%; 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background: var(--header-bg, #e8e8e8);
            box-sizing: border-box;
            border-bottom: 1px solid var(--border-color, #ddd);
        }
        .sidebar-header-buttons {
            display: flex;
            gap: 10px;
        }
        .sidebar-header button {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .sidebar-header button:hover {
            background: var(--hover-bg, rgba(0,0,0,0.1));
        }
        .sidebar-header svg {
            width: 20px;
            height: 20px;
        }
        #sidebar-chats-list {
            flex: 1;
            width: 100%;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }
        #chat-container { width: 75vw; min-width: 0; flex: 1 1 75vw; height: 100vh; box-sizing: border-box; }
        #add-user-block, #users-list { width: 100%; }
        #input-container { flex-direction: row; gap: 8px; }
        #message-input { width: 70vw; min-width: 120px; font-size: 16px; }
        #send-btn { font-size: 16px; padding: 8px 16px; }
        .modal-content { max-width: 95vw; min-width: 0; }
        @media (max-width: 900px) {
            #main-layout { flex-direction: column; height: auto; }
            #sidebar, #chat-container { width: 100vw; max-width: 100vw; flex: none; height: auto; }
        }
        @media (max-width: 600px) {
            #main-layout { flex-direction: column; }
            #sidebar { flex-direction: column; align-items: stretch; gap: 8px; width: 100vw; max-width: 100vw; height: auto; }
            #chat-container { width: 100vw; max-width: 100vw; height: auto; }
            #messages { font-size: 15px; }
            #add-user-block, #users-list { width: 100%; }
            .modal-content { max-width: 98vw; padding: 10px; }
        }
        .settings-section {
            margin: 15px 0;
            padding: 10px;
            background: var(--bg-light, #f8f8f8);
            border-radius: 8px;
        }
        .settings-section h4 {
            margin: 0 0 10px 0;
            color: var(--text-secondary, #666);
        }
        #account-info {
            font-size: 14px;
            line-height: 1.5;
        }
        #account-info p {
            margin: 5px 0;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #news-feed {
            width: 28vw;
            min-width: 220px;
            max-width: 420px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            padding: 0 0 10px 0;
        }
        #news-feed h3 {
            margin: 0;
            padding: 18px 18px 10px 18px;
            font-size: 20px;
            color: var(--accent);
        }
        #news-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 18px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .news-item {
            background: var(--bg-main);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }
        .news-item img, .news-item video {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 8px;
        }
        #news-form {
            padding: 12px 18px 0 18px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #news-text {
            min-height: 48px;
            resize: vertical;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 8px;
            font-size: 15px;
            background: var(--bg-main);
            color: var(--text-main);
        }
        #news-media {
            border: none;
            background: none;
            color: var(--text-main);
        }
        #news-publish {
            align-self: flex-end;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 7px 18px;
            font-size: 15px;
            cursor: pointer;
            margin-top: 2px;
            transition: background 0.2s;
        }
        #news-publish:hover {
            background: #005bb5;
        }
        @media (max-width: 1200px) {
            #news-feed { display: none; }
        }
        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--accent);
            font-weight: bold;
            overflow: hidden;
        }
        .avatar-small {
            width: 28px;
            height: 28px;
            font-size: 15px;
        }
        #profile-avatar-upload {
            display: none;
        }
        #profile-avatar-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin-top: 8px;
            color: var(--accent);
            font-size: 15px;
        }
        #tiktok-block {
            margin-top: 18px;
            padding: 0 18px;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }
        #tiktok-iframe-wrap iframe {
            width: 100%;
            min-height: 320px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: #000;
        }
    </style>
</head>
<body>
    <!-- <div id="loader"> ... </div> -->
    <div id="auth-modal" style="display:flex;">
        <div class="modal-content" id="auth-content">
            <h2 id="auth-title">–í—Ö–æ–¥</h2>
            <div id="server-select-block" style="margin-bottom: 12px;">
                <label for="server-select">–°–µ—Ä–≤–µ—Ä:</label>
                <select id="server-select">
                    <option value="wss://kchat-7l77.onrender.com">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä</option>
                    <option value="ws://localhost:3000">–õ–æ–∫–∞–ª—å–Ω—ã–π (ws://localhost:3000)</option>
                    <option value="custom">–î—Ä—É–≥–æ–π...</option>
                </select>
                <input type="text" id="custom-server-input" placeholder="wss://example.com" style="display:none; margin-top: 6px; width: 100%;" />
            </div>
            <div id="login-block">
                <input type="text" id="login-login" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button id="login-btn">–í–æ–π—Ç–∏</button>
                <button id="show-register-btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
            <div id="register-block" style="display:none;">
                <input type="text" id="register-login" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="password" id="register-password2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <input type="text" id="register-nick" placeholder="–ù–∏–∫ (–¥–ª—è –¥—Ä—É–∑–µ–π)">
                <button id="register-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button id="show-login-btn">–ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>
    <div id="main-layout">
        <div id="sidebar">
            <div class="sidebar-header">
                <h2>KChat</h2>
                <div class="sidebar-header-buttons">
                    <button id="theme-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button id="add-contact-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="sidebar-chats-list"></div>
        </div>
        <div id="chat-container">
            <div id="messages"></div>
            <div id="input-container">
                <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                <button id="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2"/>
                        <polygon points="22,2 15,22 11,13 2,9 22,2" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div id="theme-modal" style="display:none;">
        <div class="modal-content">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
            <select id="theme-select">
                <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                <option value="dark">–¢—ë–º–Ω–∞—è</option>
                <option value="blue">–ì–æ–ª—É–±–∞—è</option>
            </select>
            <button id="save-theme-btn">–í—ã–±—Ä–∞—Ç—å</button>
        </div>
    </div>
    <div id="settings-modal" style="display:none;">
        <div class="modal-content">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="settings-section">
                <h4>–¢–µ–º–∞</h4>
                <select id="theme-select">
                    <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                    <option value="dark">–¢—ë–º–Ω–∞—è</option>
                    <option value="blue">–ì–æ–ª—É–±–∞—è</option>
                </select>
            </div>
            <div class="settings-section">
                <h4>–ê–∫–∫–∞—É–Ω—Ç</h4>
                <div id="account-info">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span id="profile-avatar-wrap"></span>
                        <label id="profile-avatar-label">
                            <input type="file" id="profile-avatar-upload" accept="image/*">
                            –°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                        </label>
                    </div>
                    <p>ID: <span id="account-id">-</span></p>
                    <p>–ù–∏–∫: <span id="account-nick">-</span></p>
                </div>
            </div>
            <button id="close-settings-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    <div id="add-contact-modal" style="display:none;">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <input type="text" id="add-contact-id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <div class="modal-buttons">
                <button id="add-contact-confirm">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button id="add-contact-cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    <script>
        // --- –°–µ—Ä–≤–µ—Ä ---
        function getSelectedServer() {
            const select = document.getElementById('server-select');
            if (!select) return 'wss://kchat-7l77.onrender.com';
            if (select.value === 'custom') {
                return document.getElementById('custom-server-input').value.trim();
            }
            return select.value;
        }
        function saveSelectedServer() {
            const server = getSelectedServer();
            if (server) localStorage.setItem('kchat-server', server);
        }
        function loadSelectedServer() {
            const saved = localStorage.getItem('kchat-server');
            const select = document.getElementById('server-select');
            const customInput = document.getElementById('custom-server-input');
            if (!select || !customInput) return;
            if (!saved || saved === 'wss://kchat-7l77.onrender.com' || saved === 'ws://localhost:3000') {
                select.value = saved || 'wss://kchat-7l77.onrender.com';
                customInput.style.display = 'none';
            } else {
                select.value = 'custom';
                customInput.style.display = '';
                customInput.value = saved;
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('server-select');
            const customInput = document.getElementById('custom-server-input');
            if (select && customInput) {
                select.addEventListener('change', function() {
                    if (select.value === 'custom') {
                        customInput.style.display = '';
                        customInput.focus();
                    } else {
                        customInput.style.display = 'none';
                        saveSelectedServer();
                    }
                });
                customInput.addEventListener('input', saveSelectedServer);
                select.addEventListener('input', saveSelectedServer);
                loadSelectedServer();
            }
        });
        // --- –¢–µ–º–∞ ---
        function applyTheme(theme) {
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-blue');
            document.body.classList.add('theme-' + theme);
            localStorage.setItem('kchat-theme', theme);
            // –û–±–Ω–æ–≤–ª—è–µ–º select –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = theme;
            }
        }
        // --- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
        document.addEventListener('DOMContentLoaded', function() {
            let savedTheme = localStorage.getItem('kchat-theme');
            if (!savedTheme) {
                document.getElementById('theme-modal').style.display = 'flex';
            } else {
                applyTheme(savedTheme);
            }
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('main-layout').style.display = 'none';
        });
        document.getElementById('save-theme-btn').onclick = function() {
            let theme = document.getElementById('theme-select').value;
            localStorage.setItem('kchat-theme', theme);
            applyTheme(theme);
            document.getElementById('theme-modal').style.display = 'none';
            document.getElementById('main-layout').style.display = 'flex';
        };

        // --- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–ª–æ–≥–∏–Ω ---
        let myId = null;
        let myNick = null;
        let ws = null;
        let users = [];
        let chats = {};
        let currentUser = null;
        let editIdx = null;
        let contacts = JSON.parse(localStorage.getItem('kchat-contacts') || '[]');

        function showAuth(mode) {
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('login-block').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('register-block').style.display = mode === 'register' ? 'block' : 'none';
            document.getElementById('auth-title').textContent = mode === 'login' ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
        }
        function tryAutoLogin() {
            let saved = localStorage.getItem('kchat-account');
            let server = localStorage.getItem('kchat-server') || 'wss://kchat-7l77.onrender.com';
            if (saved) {
                let acc = JSON.parse(saved);
                ws = new WebSocket(server);
                ws.onopen = () => {
                    ws.send(JSON.stringify({
                        type: 'login',
                        login: acc.login,
                        password: acc.password
                    }));
                };
                ws.onmessage = (event) => handleServer(event, true);
            } else {
                showAuth('login');
            }
        }
        document.getElementById('show-register-btn').onclick = () => showAuth('register');
        document.getElementById('show-login-btn').onclick = () => showAuth('login');
        document.getElementById('login-btn').onclick = function() {
            let server = localStorage.getItem('kchat-server') || 'wss://kchat-7l77.onrender.com';
            ws = new WebSocket(server);
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: 'login',
                    login: document.getElementById('login-login').value.trim(),
                    password: document.getElementById('login-password').value
                }));
            };
            ws.onmessage = (event) => handleServer(event, false);
        };
        document.getElementById('register-btn').onclick = function() {
            let server = localStorage.getItem('kchat-server') || 'wss://kchat-7l77.onrender.com';
            const login = document.getElementById('register-login').value.trim();
            const pass1 = document.getElementById('register-password').value;
            const pass2 = document.getElementById('register-password2').value;
            const nick = document.getElementById('register-nick').value.trim();
            if (!login || !pass1 || !pass2 || !nick) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
            if (pass1 !== pass2) return alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
            ws = new WebSocket(server);
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: 'register',
                    login, password: pass1, nick
                }));
            };
            ws.onmessage = (event) => handleServer(event, false, {login, password: pass1});
        };
        function handleServer(event, isAuto, saveAcc) {
            const data = JSON.parse(event.data);
            if (data.error) return alert(data.text);
            if (data.system && data.nick && data.id) {
                myId = data.id;
                myNick = data.nick;
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('main-layout').style.display = 'flex';
                initChat();
            } else if (data.system) {
                alert(data.text);
            } else if (data.from && data.text) {
                receiveMessage(data.from, data.nick, data.text);
            }
        }

        // --- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞ ---
        function showChatMenu() {
            document.getElementById('chat-menu').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
            renderMenuChats();
        }
        function showChatContainer() {
            document.getElementById('chat-menu').style.display = 'none';
            document.getElementById('chat-container').style.display = '';
        }
        function renderMenuChats() {
            const listDiv = document.getElementById('menu-chats-list');
            listDiv.innerHTML = '';
            (users || []).forEach((userId) => {
                const card = document.createElement('div');
                card.className = 'menu-chat-card';
                const avatar = document.createElement('div');
                avatar.className = 'menu-chat-avatar';
                avatar.textContent = userId.charAt(0).toUpperCase();
                const info = document.createElement('div');
                info.className = 'menu-chat-info';
                const title = document.createElement('div');
                title.className = 'menu-chat-title';
                title.textContent = userId;
                info.appendChild(title);
                card.appendChild(avatar);
                card.appendChild(info);
                card.onclick = () => {
                    currentUser = userId;
                    localStorage.setItem('kchat-lastchat', userId);
                    showChatContainer();
                    renderUsers();
                    renderMessages();
                };
                listDiv.appendChild(card);
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            const homeBtn = document.getElementById('home-btn');
            const menuAddChatBtn = document.getElementById('menu-add-chat-btn');
            const menuBotBtn = document.getElementById('menu-bot-btn');
            const menuAccountBtn = document.getElementById('menu-account-btn');
            const menuSettingsBtn = document.getElementById('menu-settings-btn');
            const menuAddContactBtn = document.getElementById('menu-add-contact-btn');
            const addContactModal = document.getElementById('add-contact-modal');
            const addContactId = document.getElementById('add-contact-id');
            const addContactConfirm = document.getElementById('add-contact-confirm');
            const addContactCancel = document.getElementById('add-contact-cancel');
            if (homeBtn) {
                homeBtn.onclick = () => {
                    showChatMenu();
                };
            }
            if (menuAddContactBtn) {
                menuAddContactBtn.onclick = () => {
                    addContactModal.style.display = 'flex';
                    addContactId.value = '';
                    addContactId.focus();
                };
            }
            if (addContactCancel) {
                addContactCancel.onclick = () => {
                    addContactModal.style.display = 'none';
                };
            }
            if (addContactConfirm) {
                addContactConfirm.onclick = () => {
                    const id = addContactId.value.trim();
                    if (id && !users.includes(id)) {
                        users.push(id);
                        chats[id] = [];
                        addContactModal.style.display = 'none';
                        showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                        renderMenuChats();
                    } else if (users.includes(id)) {
                        showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –µ—Å—Ç—å!', 'error');
                    }
                };
            }
            if (menuAddChatBtn) {
                menuAddChatBtn.onclick = () => {
                    document.getElementById('chat-menu').style.display = 'none';
                    // –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞ (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ)
                    // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É –∏–ª–∏ –∏–Ω–ª–∞–π–Ω-–ø–æ–ª–µ
                    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å)
                    // alert('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ —Å–≤–æ–µ–º—É –∂–µ–ª–∞–Ω–∏—é');
                };
            }
            if (menuBotBtn) {
                menuBotBtn.onclick = () => {
                    currentUser = '__bot__';
                    if (!chats['__bot__']) {
                        chats['__bot__'] = [];
                        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞
                        chats['__bot__'].push({ 
                            from: '__bot__', 
                            nick: '–ü–æ–º–æ—â–Ω–∏–∫', 
                            text: '–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ—â–Ω–∏–∫ HKC. –ù–∞–ø–∏—à–∏—Ç–µ "HKC, –ø–æ–º–æ—â—å" –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.' 
                        });
                    }
                    showChatContainer();
                    renderUsers();
                    renderMessages();
                    setTimeout(() => {
                        document.getElementById('message-input').focus();
                    }, 100);
                };
            }
            if (menuAccountBtn) {
                menuAccountBtn.onclick = () => {
                    alert('–ê–∫–∫–∞—É–Ω—Ç: ' + (myNick || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + (myId ? ' (ID: ' + myId + ')' : ''));
                };
            }
            if (menuSettingsBtn) {
                menuSettingsBtn.onclick = () => {
                    themeModal.style.display = 'flex';
                };
            }
            // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
            showChatMenu();
        });
        // --- –ß–∞—Ç ---
        function initChat() {
            const usersListDiv = document.getElementById('users-list');
            const addUserInput = document.getElementById('add-user-input');
            const addUserBtn = document.getElementById('add-user-btn');
            const chatTitle = document.getElementById('chat-title');
            const messagesDiv = document.getElementById('messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const settingsModal = document.getElementById('settings-modal');
            const editTextInput = document.getElementById('edit-text');
            const saveEditBtn = document.getElementById('save-edit-btn');
            const deleteEditBtn = document.getElementById('delete-edit-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const themeBtn = document.getElementById('theme-btn');
            const themeModal = document.getElementById('theme-modal');
            const themeSelect = document.getElementById('theme-select');
            const closeThemeBtn = document.getElementById('close-theme-btn');
            const addContactBtn = document.getElementById('add-contact-btn');
            const videoCallBtn = document.getElementById('video-call-btn');
            const voiceCallBtn = document.getElementById('voice-call-btn');
            const attachBtn = document.getElementById('attach-btn');
            const emojiBtn = document.getElementById('emoji-btn');
            const homeBtn = document.getElementById('home-btn');
            const settingsBtn = document.getElementById('settings-btn');

            function renderUsers() {
                usersListDiv.innerHTML = '';
                users.forEach((userId, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'chat-btn' + (userId === currentUser ? ' active' : '');
                    btn.textContent = 'ID: ' + userId;
                    btn.onclick = () => {
                        currentUser = userId;
                        localStorage.setItem('kchat-lastchat', userId);
                        renderUsers();
                        renderMessages();
                    };
                    usersListDiv.appendChild(btn);
                });
            }

            addUserBtn.onclick = () => {
                const id = addUserInput.value.trim();
                if (id && !users.includes(id)) {
                    users.push(id);
                    chats[id] = [];
                    currentUser = id;
                    localStorage.setItem('kchat-lastchat', id);
                    addUserInput.value = '';
                    renderUsers();
                    renderMessages();
                }
            };

            addUserInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') addUserBtn.click();
            });

            function renderMessages() {
                if (currentUser === '__bot__') {
                    chatTitle.textContent = '–ü–æ–º–æ—â–Ω–∏–∫';
                    chatAvatar.textContent = 'ü§ñ';
                    chatAvatar.style.display = 'flex';
                    addContactBtn.style.display = 'none';
                }
                messagesDiv.innerHTML = '';
                if (!currentUser) {
                    messagesDiv.innerHTML = `<div class="empty-chat">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å‚Ä¶</div>`;
                } else if (chats[currentUser]) {
                    chats[currentUser].forEach((msg, idx) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = `message ${msg.from === myId ? 'samrat' : 'other'}`;
                        msgDiv.innerHTML = `<span class="user">${msg.from === myId ? "–í—ã" : (msg.nick || msg.from)}:</span> ${msg.text}`;
                        if (msg.from === myId) {
                            msgDiv.oncontextmenu = function(e) {
                                e.preventDefault();
                                editIdx = idx;
                                editTextInput.value = msg.text;
                                settingsModal.style.display = 'flex';
                            };
                        }
                        messagesDiv.appendChild(msgDiv);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }

            sendBtn.onclick = () => {
                const text = messageInput.value.trim();
                if (text && currentUser && ws && ws.readyState === 1 && currentUser !== '__bot__') {
                    ws.send(JSON.stringify({ type: 'msg', to: currentUser, text }));
                    if (!chats[currentUser]) chats[currentUser] = [];
                    chats[currentUser].push({ from: myId, nick: myNick, text });
                    messageInput.value = '';
                    renderMessages();
                }
                // –î–ª—è –ø–æ–º–æ—â–Ω–∏–∫–∞
                else if (text && currentUser === '__bot__') {
                    if (!chats['__bot__']) chats['__bot__'] = [];
                    chats['__bot__'].push({ from: myId, nick: myNick, text });
                    const replyOrPromise = getBotReply(text);
                    if (replyOrPromise instanceof Promise) {
                        replyOrPromise.then(reply => {
                            chats['__bot__'].push({ from: '__bot__', nick: '–ü–æ–º–æ—â–Ω–∏–∫', text: reply });
                            renderMessages();
                        });
                    } else {
                        setTimeout(() => {
                            chats['__bot__'].push({ from: '__bot__', nick: '–ü–æ–º–æ—â–Ω–∏–∫', text: replyOrPromise });
                            renderMessages();
                        }, 400);
                    }
                    messageInput.value = '';
                    renderMessages();
                }
            };

            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') sendBtn.click();
            });

            function receiveMessage(fromId, nick, text) {
                if (!users.includes(fromId)) {
                    users.push(fromId);
                    chats[fromId] = [];
                }
                if (!chats[fromId]) chats[fromId] = [];
                chats[fromId].push({ from: fromId, nick, text });
                renderUsers();
                if (currentUser === fromId) renderMessages();
            }

            saveEditBtn.onclick = () => {
                if (editIdx !== null && editTextInput.value.trim() && currentUser) {
                    if (chats[currentUser][editIdx].from === myId) {
                        chats[currentUser][editIdx].text = editTextInput.value.trim();
                        renderMessages();
                    }
                }
                settingsModal.style.display = 'none';
            };

            deleteEditBtn.onclick = () => {
                if (editIdx !== null && currentUser) {
                    if (chats[currentUser][editIdx].from === myId) {
                        chats[currentUser].splice(editIdx, 1);
                        renderMessages();
                    }
                }
                settingsModal.style.display = 'none';
            };

            closeModalBtn.onclick = () => {
                settingsModal.style.display = 'none';
            };

            settingsModal.onclick = (e) => {
                if (e.target === settingsModal) settingsModal.style.display = 'none';
            };

            themeBtn.onclick = () => {
                themeModal.style.display = 'flex';
            };
            closeThemeBtn.onclick = () => {
                themeModal.style.display = 'none';
            };
            themeSelect.onchange = () => {
                applyTheme(themeSelect.value);
            };

            homeBtn.onclick = () => {
                currentUser = null;
                localStorage.removeItem('kchat-lastchat');
                renderUsers();
                renderMessages();
            };

            settingsBtn.onclick = () => {
                settingsModal.style.display = 'flex';
            };

            // --- –ö–æ–Ω—Ç–∞–∫—Ç—ã ---
            addContactBtn.onclick = () => {
                if (currentUser && !contacts.find(c => c.id === currentUser)) {
                    contacts.push({ id: currentUser, nick: chats[currentUser]?.[0]?.nick || currentUser });
                    localStorage.setItem('kchat-contacts', JSON.stringify(contacts));
                    showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                }
            };

            // --- –í–∏–¥–µ–æ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ ---
            videoCallBtn.onclick = () => {
                if (currentUser) {
                    showNotification('–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–µ–º–æ –≤–µ—Ä—Å–∏–∏', 'info');
                }
            };

            voiceCallBtn.onclick = () => {
                if (currentUser) {
                    showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–µ–º–æ –≤–µ—Ä—Å–∏–∏', 'info');
                }
            };

            // --- –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ ---
            attachBtn.onclick = () => {
                showNotification('–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –¥–µ–º–æ –≤–µ—Ä—Å–∏–∏', 'info');
            };

            // --- –≠–º–æ–¥–∑–∏ ---
            emojiBtn.onclick = () => {
                const emojis = ['üòÄ', 'üòÇ', 'üòç', 'ü§î', 'üëç', '‚ù§Ô∏è', 'üî•', 'üíØ', 'üéâ', 'üëã'];
                const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                messageInput.value += randomEmoji;
                messageInput.focus();
            };

            // --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ---
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--accent);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px var(--shadow);
                    z-index: 10000;
                    font-weight: 500;
                    animation: slideInRight 0.3s ease;
                `;
                
                if (type === 'success') {
                    notification.style.background = '#34C759';
                } else if (type === 'error') {
                    notification.style.background = '#FF3B30';
                }
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            // --- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞—Ç–∞ ---
            let lastChat = localStorage.getItem('kchat-lastchat');
            if (lastChat && users.includes(lastChat)) {
                currentUser = lastChat;
            }

            renderUsers();
            renderMessages();
        }

        // --- –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ ---
        async function translateText(text, targetLang) {
            const url = 'https://google-translate1.p.rapidapi.com/language/translate/v2';
            const params = new URLSearchParams();
            params.append('q', text);
            params.append('target', targetLang);
            params.append('source', 'auto');
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'content-type': 'application/x-www-form-urlencoded',
                    'Accept-Encoding': 'application/gzip',
                    'X-RapidAPI-Key': '2b92c1f5e6msh888d1aba9edebc0p1f0361jsn18fc0f8a7da0',
                    'X-RapidAPI-Host': 'google-translate1.p.rapidapi.com'
                },
                body: params
            });
            const data = await response.json();
            return data.data.translations[0].translatedText;
        }

        // --- –ü–æ–º–æ—â–Ω–∏–∫ ---
        function getBotReply(text) {
            const t = text.trim().toLowerCase();
            // --- –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ ---
            if (/hkc[ ,]*–ø–µ—Ä–µ–≤–µ–¥–∏.*–Ω–∞/.test(t)) {
                // –ü—Ä–∏–º–µ—Ä: HKC, –ø–µ—Ä–µ–≤–µ–¥–∏ "hello" –Ω–∞ —Ä—É—Å—Å–∫–∏–π
                const match = t.match(/–ø–µ—Ä–µ–≤–µ–¥–∏[ ]*["']?(.+?)["']? –Ω–∞ ([–∞-—èa-z]+)/i);
                if (match) {
                    const phrase = match[1];
                    const lang = match[2];
                    const langMap = { '—Ä—É—Å—Å–∫–∏–π': 'ru', '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π': 'en', '–∫–∞–∑–∞—Ö—Å–∫–∏–π': 'kk', '–Ω–µ–º–µ—Ü–∫–∏–π': 'de', '—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π': 'fr', 'kz': 'kk', 'en': 'en', 'ru': 'ru' };
                    const targetLang = langMap[lang.toLowerCase()] || 'ru';
                    return new Promise(async (resolve) => {
                        try {
                            const translated = await translateText(phrase, targetLang);
                            resolve('–ü–µ—Ä–µ–≤–æ–¥: ' + translated);
                        } catch (e) {
                            resolve('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: ' + e.message);
                        }
                    });
                }
            }
            // –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
            if (/hkc[ ,]*—Å—Ç–∞—Ä—Ç|hkc[ ,]*–Ω–∞—á–∞—Ç—å/.test(t)) return 'HKC –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';
            if (/hkc[ ,]*–ø–æ–º–æ—â—å/.test(t)) return '–í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n- –ü–æ–≥–æ–¥–∞: "HKC, –ø–æ–≥–æ–¥–∞ –≤ –ê–ª–º–∞—Ç—ã"\n- –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç: "HKC, –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞"\n- –ù–æ–≤–æ—Å—Ç–∏: "HKC, —Å–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞"\n- –ì–æ—Å—É—Å–ª—É–≥–∏: "HKC, –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —à—Ç—Ä–∞—Ñ—ã?"\n- –ü–µ—Ä–µ–≤–æ–¥—ã: "HKC, –ø–µ—Ä–µ–≤–µ–¥–∏ ..."\n- –¢–∞–π–º–µ—Ä—ã: "HKC, —Ç–∞–π–º–µ—Ä 20 –º–∏–Ω—É—Ç"\n- –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: "HKC, —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 15000 —Ç–µ–Ω–≥–µ –≤ —Ä—É–±–ª—è—Ö?"\n- –¢—Ä–∞–¥–∏—Ü–∏–∏: "HKC, —á—Ç–æ —Ç–∞–∫–æ–µ –ù–∞—É—Ä—ã–∑?"\n- –ë–∏–∑–Ω–µ—Å: "HKC, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –ò–ü?"\n- –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è: "HKC, –∞–Ω–µ–∫–¥–æ—Ç"';
            if (/hkc[ ,]*—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å/.test(t)) return '–î–∞, —è –æ–Ω–ª–∞–π–Ω. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å!';
            if (/hkc[ ,]*–∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª/.test(t)) return '–ú–æ—è –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ :)';
            // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
            if (/hkc[ ,]*–ø–æ–≥–æ–¥–∞/.test(t)) return '–ü–æ–≥–æ–¥–∞: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (/hkc[ ,]*–∫—É—Ä—Å|hkc[ ,]*–æ–±–º–µ–Ω–Ω—ã–π –∫—É—Ä—Å/.test(t)) return '–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (/hkc[ ,]*–Ω–æ–≤–æ—Å—Ç–∏/.test(t)) return '–ù–æ–≤–æ—Å—Ç–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (/hkc[ ,]*—à—Ç—Ä–∞—Ñ|hkc[ ,]*—Å–ø—Ä–∞–≤–∫/.test(t)) return '–ì–æ—Å—É—Å–ª—É–≥–∏: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            // –£—Ç–∏–ª–∏—Ç—ã
            if (/hkc[ ,]*–ø–µ—Ä–µ–≤–µ–¥–∏.*—Å–ø–∞—Å–∏–±–æ/.test(t)) return '–†–∞—Ö–º–µ—Ç';
            if (/hkc[ ,]*–ø–µ—Ä–µ–≤–µ–¥–∏.*–ø—Ä–∏–≤–µ—Ç/.test(t)) return '–°”ô–ª–µ–º';
            if (/hkc[ ,]*–∫–∞–∫ —Å–∫–∞–∑–∞—Ç—å.*–ø—Ä–∏–≤–µ—Ç/.test(t)) return '–°”ô–ª–µ–º';
            if (/hkc[ ,]*–Ω–∞–ø–æ–º–Ω–∏/.test(t)) return '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞).';
            if (/hkc[ ,]*—Ç–∞–π–º–µ—Ä/.test(t)) return '–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω (–∑–∞–≥–ª—É—à–∫–∞).';
            if (/hkc[ ,]*—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç/.test(t)) return '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (/hkc[ ,]*–Ω–¥—Å/.test(t)) return '–†–∞—Å—á—ë—Ç –ù–î–°: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            // –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∫—É–ª—å—Ç—É—Ä–∞
            if (/hkc[ ,]*–Ω–∞—É—Ä—ã–∑/.test(t)) return '–ù–∞—É—Ä—ã–∑ ‚Äî –≥–ª–∞–≤–Ω—ã–π –≤–µ—Å–µ–Ω–Ω–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫ —É –∫–∞–∑–∞—Ö–æ–≤, —Å–∏–º–≤–æ–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ä–æ–¥—ã.';
            if (/hkc[ ,]*–±–µ—à–±–∞—Ä–º–∞–∫/.test(t)) return '–ë–µ—à–±–∞—Ä–º–∞–∫ ‚Äî —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ –∫–∞–∑–∞—Ö—Å–∫–æ–µ –±–ª—é–¥–æ –∏–∑ –º—è—Å–∞ –∏ –ª–∞–ø—à–∏.';
            if (/hkc[ ,]*—Ç–µ—Å—Ç.*–∫–∞–∑–∞—Ö—Å–∫/.test(t)) return '–ö–∞–∫ –±—É–¥–µ—Ç "—Å–µ–º—å—è" –ø–æ-–∫–∞–∑–∞—Ö—Å–∫–∏? ‚Äî "–û—Ç–±–∞—Å—ã"';
            if (/hkc[ ,]*—Å–∫–ª–æ–Ω–µ–Ω–∏–µ.*“õ–∞–∑–∞“õ—Å—Ç–∞–Ω/.test(t)) return '–°–∫–ª–æ–Ω–µ–Ω–∏–µ: “ö–∞–∑–∞“õ—Å—Ç–∞–Ω ‚Äî “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–¥–∞, “ö–∞–∑–∞“õ—Å—Ç–∞–Ω–Ω–∞–Ω, “ö–∞–∑–∞“õ—Å—Ç–∞–Ω“ì–∞ –∏ —Ç.–¥.';
            // –î–ª—è –±–∏–∑–Ω–µ—Å–∞
            if (/hkc[ ,]*–≥–¥–µ.*–≤–∞–ª—é—Ç—É/.test(t)) return '–ü—É–Ω–∫—Ç—ã –æ–±–º–µ–Ω–∞ –≤–∞–ª—é—Ç—ã: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (/hkc[ ,]*–Ω–∞–ª–æ–≥–æ–≤–æ–π/.test(t)) return '–ù–æ–º–µ—Ä –Ω–∞–ª–æ–≥–æ–≤–æ–π –ê—Å—Ç–∞–Ω—ã: +7 (7172) 123-456';
            if (/hkc[ ,]*–¥–æ–∫—É–º–µ–Ω—Ç.*–∏–ø/.test(t)) return '–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ò–ü –Ω—É–∂–Ω—ã: —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏, –∑–∞—è–≤–ª–µ–Ω–∏–µ, –∞–¥—Ä–µ—Å.';
            if (/hkc[ ,]*–∑–∞–∫–æ–Ω.*—Ü–∏—Ñ—Ä–æ–≤—ã—Ö –≤–∞–ª—é—Ç/.test(t)) return '–ó–∞–∫–æ–Ω –æ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –≤–∞–ª—é—Ç–∞—Ö –†–ö: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            // –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
            if (/hkc[ ,]*—Ñ–∏–ª—å–º/.test(t)) return '–ö–∞–∑–∞—Ö—Å–∫–∏–µ —Ñ–∏–ª—å–º—ã –º–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ kinopoisk.kz, ivi.kz, or Qazaqstan TV.';
            if (/hkc[ ,]*–ø–µ—Å–Ω—è.*–∞“õ“õ—É—ã–º/.test(t)) return '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ "–ê“õ“õ—É—ã–º": —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (/hkc[ ,]*–∑–∞–≥–∞–¥–∫/.test(t)) return '–ó–∞–≥–∞–¥–∫–∞: –ë–µ–∑ —è–∑—ã–∫–∞, –∞ –≥–æ–≤–æ—Ä–∏—Ç. (–û—Ç–≤–µ—Ç: –ö–æ–ª–æ–∫–æ–ª)';
            if (/hkc[ ,]*–ø–µ—Ä–≤—ã–π –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç/.test(t)) return '–ü–µ—Ä–≤—ã–π –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç –†–ö ‚Äî –ù—É—Ä—Å—É–ª—Ç–∞–Ω –ù–∞–∑–∞—Ä–±–∞–µ–≤.';
            // –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞
            if (/hkc[ ,]*–æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à/.test(t)) return '–ß—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à, –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à".';
            if (/hkc[ ,]*–æ—à–∏–±–∫–∞ 404/.test(t)) return '–û—à–∏–±–∫–∞ 404 ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å.';
            if (/hkc[ ,]*—Å—Ç–∞—Ç—É—Å api/.test(t)) return 'API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞).';
            if (/hkc[ ,]*–ª–æ–≥[–∏—ã]/.test(t)) return '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            // –ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞
            if (/hkc[ ,]*–≥–¥–µ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã/.test(t)) return '–ë–∏–ª–µ—Ç—ã –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ railway.kz –∏–ª–∏ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–ñ–î –±–∏–ª–µ—Ç—ã –†–ö". –•–æ—Ç–∏—Ç–µ —Å—Å—ã–ª–∫—É?';
            // –û–±—â–∏–µ –æ—Ç–≤–µ—Ç—ã
            if (t.includes('–ø—Ä–∏–≤–µ—Ç')) return '–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';
            if (t.includes('–≤—Ä–µ–º—è')) return '–°–µ–π—á–∞—Å ' + new Date().toLocaleTimeString();
            if (t.includes('–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç')) return '–Ø –ø–æ–º–æ—â–Ω–∏–∫ HKC!';
            if (t.includes('–ø–æ–º–æ–≥–∏')) return '–ù–∞–ø–∏—à–∏—Ç–µ "HKC, –ø–æ–º–æ—â—å" –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.';
            if (t.includes('–∞–Ω–µ–∫–¥–æ—Ç')) return '–ö–æ–ª–æ–±–æ–∫ –ø–æ–≤–µ—Å–∏–ª—Å—è. (—à—É—Ç–∫–∞!)';
            if (t.includes('–ø–æ–≥–æ–¥–∞')) return '–ü–æ–≥–æ–¥–∞: —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ!';
            if (t.includes('—Å–ø–∞—Å–∏–±–æ')) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!';
            if (t.includes('–∫–æ–º–∞–Ω–¥—ã')) return '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: HKC, –ø–æ–º–æ—â—å, –ø–æ–≥–æ–¥–∞, –∫—É—Ä—Å, –Ω–æ–≤–æ—Å—Ç–∏, –≥–æ—Å—É—Å–ª—É–≥–∏, –ø–µ—Ä–µ–≤–æ–¥—ã, —Ç–∞–π–º–µ—Ä, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, —Ç—Ä–∞–¥–∏—Ü–∏–∏, –±–∏–∑–Ω–µ—Å, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞.';
            if (t.includes('–ø–æ–∫–∞')) return '–î–æ –≤—Å—Ç—Ä–µ—á–∏!';
            return '–Ø –Ω–µ –ø–æ–Ω—è–ª, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "HKC, –ø–æ–º–æ—â—å".';
        }

        // --- –ê–≤–∞—Ç–∞—Ä–∫–∏ ---
        function getMyAvatar() {
            return localStorage.getItem('kchat-avatar') || '';
        }
        function setMyAvatar(dataUrl) {
            localStorage.setItem('kchat-avatar', dataUrl);
        }
        function renderProfileAvatar() {
            const wrap = document.getElementById('profile-avatar-wrap');
            if (!wrap) return;
            wrap.innerHTML = '';
            const avatarUrl = getMyAvatar();
            let el;
            if (avatarUrl) {
                el = document.createElement('img');
                el.src = avatarUrl;
                el.className = 'avatar';
                el.alt = 'avatar';
            } else {
                el = document.createElement('div');
                el.className = 'avatar';
                el.textContent = (myNick ? myNick[0] : 'U').toUpperCase();
            }
            wrap.appendChild(el);
        }
        // --- –í—Å—Ç–∞–≤–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∏ —á–∞—Ç–æ–≤ ---
        function getUserAvatar(userId) {
            if (userId === myId) return getMyAvatar();
            // –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å: —Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            return '';
        }
        // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã ---
        const SPECIAL_CHATS = [
            { id: '__news__', name: '–ù–æ–≤–æ—Å—Ç–∏', icon: 'üì∞' }
        ];
        function renderSidebarChats() {
            const listDiv = document.getElementById('sidebar-chats-list');
            listDiv.innerHTML = '';
            // –°–ø–µ—Ü—á–∞—Ç—ã —Å–≤–µ—Ä—Ö—É
            SPECIAL_CHATS.forEach(special => {
                const card = document.createElement('div');
                card.className = 'sidebar-chat-card' + (special.id === currentUser ? ' active' : '');
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = special.icon;
                card.appendChild(avatar);
                const info = document.createElement('div');
                info.className = 'sidebar-chat-info';
                const title = document.createElement('div');
                title.className = 'sidebar-chat-title';
                title.textContent = special.name;
                info.appendChild(title);
                card.appendChild(info);
                card.onclick = () => {
                    currentUser = special.id;
                    renderSidebarChats();
                    renderMessages();
                };
                listDiv.appendChild(card);
            });
            // –û–±—ã—á–Ω—ã–µ —á–∞—Ç—ã
            const allChats = ['__bot__', ...users.filter(u => u !== '__bot__')];
            allChats.forEach((userId) => {
                const card = document.createElement('div');
                card.className = 'sidebar-chat-card' + (userId === currentUser ? ' active' : '');
                let avatar;
                if (userId === '__bot__') {
                    avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.textContent = 'ü§ñ';
                } else {
                    const avatarUrl = getUserAvatar(userId);
                    if (avatarUrl) {
                        avatar = document.createElement('img');
                        avatar.src = avatarUrl;
                        avatar.className = 'avatar';
                        avatar.alt = 'avatar';
                    } else {
                        avatar = document.createElement('div');
                        avatar.className = 'avatar';
                        avatar.textContent = userId.charAt(0).toUpperCase();
                    }
                }
                card.appendChild(avatar);
                const info = document.createElement('div');
                info.className = 'sidebar-chat-info';
                const title = document.createElement('div');
                title.className = 'sidebar-chat-title';
                title.textContent = userId === '__bot__' ? '–ü–æ–º–æ—â–Ω–∏–∫' : userId;
                const lastMsg = (chats[userId] && chats[userId].length > 0) ? chats[userId][chats[userId].length-1] : null;
                const msg = document.createElement('div');
                msg.className = 'sidebar-chat-msg';
                msg.textContent = lastMsg ? (lastMsg.text.length > 30 ? lastMsg.text.slice(0,30)+'‚Ä¶' : lastMsg.text) : '';
                info.appendChild(title);
                info.appendChild(msg);
                card.appendChild(info);
                card.onclick = () => {
                    currentUser = userId;
                    renderSidebarChats();
                    renderMessages();
                };
                listDiv.appendChild(card);
            });
        }

        // --- –ê–≤–∞—Ç–∞—Ä–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö ---
        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            // --- –ù–æ–≤–æ—Å—Ç–∏ –∫–∞–∫ —á–∞—Ç ---
            if (currentUser === '__news__') {
                messagesDiv.innerHTML = '';
                news.slice().reverse().forEach(item => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    let avatarHtml = '';
                    if (item.avatar) {
                        avatarHtml = `<img src="${item.avatar}" class="avatar avatar-small" alt="avatar">`;
                    } else {
                        avatarHtml = `<span class="avatar avatar-small">${(item.nick||'U')[0].toUpperCase()}</span>`;
                    }
                    msgDiv.innerHTML = `<div style='display:flex;align-items:center;gap:10px;margin-bottom:6px;'>${avatarHtml}<b>${item.nick||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</b></div><div>${item.text}</div>`;
                    if (item.media && item.mediaType) {
                        if (item.mediaType.startsWith('image/')) {
                            msgDiv.innerHTML += `<img src="${item.media}" alt="news image">`;
                        } else if (item.mediaType.startsWith('video/')) {
                            msgDiv.innerHTML += `<video src="${item.media}" controls></video>`;
                        }
                    }
                    messagesDiv.appendChild(msgDiv);
                });
                // –§–æ—Ä–º–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏
                const formDiv = document.createElement('div');
                formDiv.style.marginTop = '18px';
                formDiv.innerHTML = `
                    <textarea id="news-text" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏..." style="width:100%;min-height:48px;margin-bottom:6px;"></textarea>
                    <input type="file" id="news-media" accept="image/*,video/*" style="margin-bottom:6px;">
                    <button id="news-publish">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                `;
                messagesDiv.appendChild(formDiv);
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                setTimeout(() => {
                    const newsPublish = document.getElementById('news-publish');
                    if (newsPublish) {
                        newsPublish.onclick = async function() {
                            const text = document.getElementById('news-text').value.trim();
                            const mediaInput = document.getElementById('news-media');
                            let media = null, mediaType = null;
                            if (mediaInput.files && mediaInput.files[0]) {
                                const file = mediaInput.files[0];
                                mediaType = file.type;
                                media = await new Promise(r => {
                                    const reader = new FileReader();
                                    reader.onload = e => r(e.target.result);
                                    reader.readAsDataURL(file);
                                });
                            }
                            if (!text && !media) return;
                            news.push({ text, media, mediaType, date: Date.now(), avatar: getMyAvatar(), nick: myNick });
                            localStorage.setItem('kchat-news', JSON.stringify(news));
                            renderMessages();
                        };
                    }
                }, 0);
                return;
            }
            // --- TikTok –∫–∞–∫ —á–∞—Ç ---
            if (currentUser === '__tiktok__') {
                messagesDiv.innerHTML = '';
                // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º TikTok —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (VPN)
                const tiktokWrap = document.createElement('div');
                tiktokWrap.style.width = '100%';
                tiktokWrap.style.height = '80vh';
                tiktokWrap.style.position = 'relative';
                tiktokWrap.innerHTML = `
                    <iframe id="tiktok-vpn-frame" src="https://proxy.tube/browse.php?u=https%3A%2F%2Fwww.tiktok.com%2F" style="width:100%;height:100%;border-radius:12px;border:1px solid var(--border-color);background:#000;" allowfullscreen></iframe>
                    <div id="tiktok-fail" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);color:#fff;align-items:center;justify-content:center;flex-direction:column;z-index:2;">
                        <div style='margin-bottom:18px;'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å TikTok –≤–Ω—É—Ç—Ä–∏ —Å–∞–π—Ç–∞.<br>–û—Ç–∫—Ä–æ–π—Ç–µ TikTok —á–µ—Ä–µ–∑ VPN –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ:</div>
                        <a href="https://proxy.tube/browse.php?u=https%3A%2F%2Fwww.tiktok.com%2F" target="_blank" style="background:var(--accent);color:#fff;padding:10px 22px;border-radius:8px;text-decoration:none;font-size:18px;">–û—Ç–∫—Ä—ã—Ç—å TikTok</a>
                    </div>
                `;
                messagesDiv.appendChild(tiktokWrap);
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ iframe (–µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
                setTimeout(() => {
                    const iframe = document.getElementById('tiktok-vpn-frame');
                    let loaded = false;
                    if (iframe) {
                        iframe.onload = function() { loaded = true; };
                        setTimeout(() => {
                            if (!loaded) {
                                document.getElementById('tiktok-fail').style.display = 'flex';
                            }
                        }, 6000);
                    }
                }, 0);
                return;
            }
            // –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (!currentUser || !chats[currentUser] || chats[currentUser].length === 0) {
                messagesDiv.innerHTML = `<div class="empty-chat">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å‚Ä¶</div>`;
                return;
            }
            chats[currentUser].forEach((msg, idx) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msg.from === myId ? 'samrat' : 'other'}`;
                let avatarHtml = '';
                if (msg.from === myId) {
                    const avatarUrl = getMyAvatar();
                    if (avatarUrl) {
                        avatarHtml = `<img src="${avatarUrl}" class="avatar avatar-small" alt="avatar">`;
                    } else {
                        avatarHtml = `<span class="avatar avatar-small">${(myNick||'U')[0].toUpperCase()}</span>`;
                    }
                } else if (msg.from === '__bot__') {
                    avatarHtml = `<span class="avatar avatar-small">ü§ñ</span>`;
                } else {
                    avatarHtml = `<span class="avatar avatar-small">${(msg.nick||msg.from)[0].toUpperCase()}</span>`;
                }
                let contentHtml = `<span class="user">${msg.from === myId ? "–í—ã" : (msg.nick || msg.from)}:</span> ${msg.text}`;
                if (msg.media && msg.mediaType && msg.mediaType.startsWith('video/')) {
                    contentHtml += `<br><video src="${msg.media}" controls style='width:100%;max-width:320px;border-radius:10px;margin-top:6px;'></video>`;
                }
                msgDiv.innerHTML = `${avatarHtml} ${contentHtml}`;
                messagesDiv.appendChild(msgDiv);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- –ê–≤–∞—Ç–∞—Ä–∫–∏ –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö ---
        function renderNews() {
            const newsList = document.getElementById('news-list');
            if (!newsList) return;
            newsList.innerHTML = '';
            news.slice().reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'news-item';
                let avatarHtml = '';
                if (item.avatar) {
                    avatarHtml = `<img src="${item.avatar}" class="avatar avatar-small" alt="avatar">`;
                } else {
                    avatarHtml = `<span class="avatar avatar-small">${(item.nick||'U')[0].toUpperCase()}</span>`;
                }
                div.innerHTML = `<div style='display:flex;align-items:center;gap:10px;margin-bottom:6px;'>${avatarHtml}<b>${item.nick||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</b></div><div>${item.text}</div>`;
                if (item.media && item.mediaType) {
                    if (item.mediaType.startsWith('image/')) {
                        div.innerHTML += `<img src="${item.media}" alt="news image">`;
                    } else if (item.mediaType.startsWith('video/')) {
                        div.innerHTML += `<video src="${item.media}" controls></video>`;
                    }
                }
                newsList.appendChild(div);
            });
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –ø–æ—Å–ª–µ –ª—é–±–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è:
        document.addEventListener('DOMContentLoaded', function() {
            renderSidebarChats();
            renderMessages();
            renderProfileAvatar(); // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        });
        // –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ —Ç.–¥. ‚Äî –≤—ã–∑—ã–≤–∞—Ç—å renderSidebarChats() –∏ renderMessages()

        document.addEventListener('DOMContentLoaded', function() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
            const themeBtn = document.getElementById('theme-btn');
            const addContactBtn = document.getElementById('add-contact-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const addContactModal = document.getElementById('add-contact-modal');
            const addContactConfirm = document.getElementById('add-contact-confirm');
            const addContactCancel = document.getElementById('add-contact-cancel');
            const accountId = document.getElementById('account-id');
            const accountNick = document.getElementById('account-nick');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
            function updateAccountInfo() {
                if (myId && myNick) {
                    accountId.textContent = myId;
                    accountNick.textContent = myNick;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            themeBtn.onclick = () => {
                updateAccountInfo();
                settingsModal.style.display = 'flex';
            };

            closeSettingsBtn.onclick = () => {
                settingsModal.style.display = 'none';
            };

            addContactBtn.onclick = () => {
                addContactModal.style.display = 'flex';
                document.getElementById('add-contact-id').value = '';
                document.getElementById('add-contact-id').focus();
            };

            addContactCancel.onclick = () => {
                addContactModal.style.display = 'none';
            };

            addContactConfirm.onclick = () => {
                const id = document.getElementById('add-contact-id').value.trim();
                if (id && !users.includes(id)) {
                    users.push(id);
                    chats[id] = [];
                    addContactModal.style.display = 'none';
                    showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    renderSidebarChats();
                } else if (users.includes(id)) {
                    showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –µ—Å—Ç—å!', 'error');
                }
            };

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö –æ–±–ª–∞—Å—Ç–∏
            window.onclick = (event) => {
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                if (event.target === addContactModal) {
                    addContactModal.style.display = 'none';
                }
            };
        });

        let news = JSON.parse(localStorage.getItem('kchat-news') || '[]');
        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ ---
        document.addEventListener('DOMContentLoaded', function() {
            renderProfileAvatar();
            const avatarInput = document.getElementById('profile-avatar-upload');
            if (avatarInput) {
                avatarInput.onchange = function() {
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            setMyAvatar(e.target.result);
                            renderProfileAvatar();
                            renderSidebarChats();
                            renderMessages();
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
        });

        // --- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–∏ —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π ---
        document.addEventListener('DOMContentLoaded', function() {
            renderNews();
            const newsPublish = document.getElementById('news-publish');
            if (newsPublish) {
                newsPublish.onclick = async function() {
                    const text = document.getElementById('news-text').value.trim();
                    const mediaInput = document.getElementById('news-media');
                    let media = null, mediaType = null;
                    if (mediaInput.files && mediaInput.files[0]) {
                        const file = mediaInput.files[0];
                        mediaType = file.type;
                        media = await new Promise(r => {
                            const reader = new FileReader();
                            reader.onload = e => r(e.target.result);
                            reader.readAsDataURL(file);
                        });
                    }
                    if (!text && !media) return;
                    news.push({ text, media, mediaType, date: Date.now(), avatar: getMyAvatar(), nick: myNick });
                    localStorage.setItem('kchat-news', JSON.stringify(news));
                    document.getElementById('news-text').value = '';
                    mediaInput.value = '';
                    renderNews();
                };
            }
        });

        // --- TikTok VPN ---
        document.addEventListener('DOMContentLoaded', function() {
            const tiktokBtn = document.getElementById('tiktok-load');
            if (tiktokBtn) {
                tiktokBtn.onclick = function() {
                    const url = document.getElementById('tiktok-url').value.trim();
                    const wrap = document.getElementById('tiktok-iframe-wrap');
                    wrap.innerHTML = '';
                    if (!url || !/^https?:\/\/(www\.)?tiktok\.com\//.test(url)) {
                        wrap.innerHTML = '<div style="color:red;">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ TikTok</div>';
                        return;
                    }
                    // –ü—Ä–æ–∫—Å–∏-iframe (—ç–º—É–ª—è—Ü–∏—è VPN):
                    // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–∏—Å—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä https://proxy.tube –∏–ª–∏ https://corsproxy.io/?
                    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º corsproxy.io
                    const proxied = 'https://corsproxy.io/?' + encodeURIComponent(url);
                    wrap.innerHTML = `<iframe src="${proxied}" allowfullscreen frameborder="0"></iframe>`;
                };
            }
        });

        // –ú–∞—Å—Å–∏–≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const TIKTOK_TAGS = [
            'viral', 'trending', 'dance', 'funny', 'comedy', 'music', 'food', 'gaming',
            'sport', 'animals', 'art', 'beauty', 'fashion', 'nature', 'travel'
        ];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        async function getRandomTikTok() {
            try {
                // –ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—ã–π —Ç–µ–≥
                const tag = TIKTOK_TAGS[Math.floor(Math.random() * TIKTOK_TAGS.length)];
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö –≤–∏–¥–µ–æ –ø–æ —Ç–µ–≥—É
                const api = `https://api.tiklydown.me/api/trending?tag=${tag}&count=1`;
                const resp = await fetch(api);
                const data = await resp.json();
                if (data && data.videos && data.videos.length > 0) {
                    return data.videos[0];
                }
                return null;
            } catch (e) {
                console.error('Error getting random TikTok:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–∞—Ä—Ç–∏–∏ –≤–∏–¥–µ–æ
        async function loadMoreTikToks(count = 3) {
            const wrap = document.getElementById('tiktok-video-wrap');
            if (!wrap) return;
            
            wrap.innerHTML += '<div class="loading-more">–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –≤–∏–¥–µ–æ...</div>';
            
            for (let i = 0; i < count; i++) {
                const video = await getRandomTikTok();
                if (video && video.video && video.video.noWatermark) {
                    const videoDiv = document.createElement('div');
                    videoDiv.className = 'tiktok-video-item';
                    videoDiv.innerHTML = `
                        <div class="video-header">
                            <span class="video-author">${video.author || 'TikTok'}</span>
                            <button class="send-video-btn" data-url="${video.video.noWatermark}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                        <video src="${video.video.noWatermark}" controls loop style="width:100%;border-radius:10px;margin:8px 0;"></video>
                        <div class="video-desc">${video.description || ''}</div>
                    `;
                    wrap.appendChild(videoDiv);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
                    const sendBtn = videoDiv.querySelector('.send-video-btn');
                    if (sendBtn) {
                        sendBtn.onclick = function() {
                            const videoUrl = this.getAttribute('data-url');
                            let chatList = users.filter(u => u !== '__bot__');
                            let selectHtml = `
                                <div class="send-video-modal">
                                    <select id="tiktok-send-to-${i}">
                                        ${chatList.map(u => `<option value="${u}">${u}</option>`).join('')}
                                    </select>
                                    <button onclick="sendTikTokTo('${videoUrl}', 'tiktok-send-to-${i}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                </div>
                            `;
                            this.insertAdjacentHTML('afterend', selectHtml);
                            this.style.display = 'none';
                        };
                    }
                }
            }
            
            const loading = wrap.querySelector('.loading-more');
            if (loading) loading.remove();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ –≤ —á–∞—Ç
        function sendTikTokTo(videoUrl, selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const to = select.value;
            if (!chats[to]) chats[to] = [];
            chats[to].push({ 
                from: myId, 
                nick: myNick, 
                text: '[TikTok –≤–∏–¥–µ–æ]', 
                media: videoUrl, 
                mediaType: 'video/mp4' 
            });
            
            // –£–¥–∞–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const modal = select.closest('.send-video-modal');
            if (modal) {
                const btn = modal.previousElementSibling;
                if (btn) btn.style.display = '';
                modal.remove();
            }
            showNotification('–í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
        const style = document.createElement('style');
        style.textContent = `
            .tiktok-video-item {
                background: var(--bg-main);
                border-radius: 12px;
                padding: 12px;
                margin-bottom: 16px;
                border: 1px solid var(--border-color);
            }
            .video-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .video-author {
                font-weight: bold;
                color: var(--accent);
            }
            .send-video-btn {
                padding: 4px 12px;
                border-radius: 6px;
                background: var(--accent);
                color: white;
                border: none;
                cursor: pointer;
            }
            .send-video-modal {
                margin-top: 8px;
                display: flex;
                gap: 8px;
            }
            .loading-more {
                text-align: center;
                padding: 10px;
                color: var(--text-secondary);
            }
            #load-more-btn {
                width: 100%;
                padding: 10px;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                margin-top: 16px;
                cursor: pointer;
            }
            #load-more-btn:hover {
                background: var(--hover-bg);
            }
        `;
        document.head.appendChild(style);

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ TikTok —á–∞—Ç–∞
        if (currentUser === '__tiktok__') {
            messagesDiv.innerHTML = '';
            // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º TikTok —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (VPN)
            const tiktokWrap = document.createElement('div');
            tiktokWrap.style.width = '100%';
            tiktokWrap.style.height = '80vh';
            tiktokWrap.style.position = 'relative';
            tiktokWrap.innerHTML = `
                <iframe id="tiktok-vpn-frame" src="https://proxy.tube/browse.php?u=https%3A%2F%2Fwww.tiktok.com%2F" style="width:100%;height:100%;border-radius:12px;border:1px solid var(--border-color);background:#000;" allowfullscreen></iframe>
                <div id="tiktok-fail" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);color:#fff;align-items:center;justify-content:center;flex-direction:column;z-index:2;">
                    <div style='margin-bottom:18px;'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å TikTok –≤–Ω—É—Ç—Ä–∏ —Å–∞–π—Ç–∞.<br>–û—Ç–∫—Ä–æ–π—Ç–µ TikTok —á–µ—Ä–µ–∑ VPN –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ:</div>
                    <a href="https://proxy.tube/browse.php?u=https%3A%2F%2Fwww.tiktok.com%2F" target="_blank" style="background:var(--accent);color:#fff;padding:10px 22px;border-radius:8px;text-decoration:none;font-size:18px;">–û—Ç–∫—Ä—ã—Ç—å TikTok</a>
                </div>
            `;
            messagesDiv.appendChild(tiktokWrap);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ iframe (–µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
            setTimeout(() => {
                const iframe = document.getElementById('tiktok-vpn-frame');
                let loaded = false;
                if (iframe) {
                    iframe.onload = function() { loaded = true; };
                    setTimeout(() => {
                        if (!loaded) {
                            document.getElementById('tiktok-fail').style.display = 'flex';
                        }
                    }, 6000);
                }
            }, 0);
            return;
        }

        // TikTok –≤–∏–¥–µ–æ, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ö—Ä–∞–Ω–∏–º –≤ localStorage)
        let tiktokUserVideos = JSON.parse(localStorage.getItem('kchat-tiktok-videos') || '[]');

        function saveTiktokUserVideos() {
            localStorage.setItem('kchat-tiktok-videos', JSON.stringify(tiktokUserVideos));
        }

    </script>
</body>
</html>
